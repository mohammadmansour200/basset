import { open } from "@tauri-apps/plugin-dialog";
import { useCallback, useEffect } from "react";
import { useTranslation } from "react-i18next";

import { Ripple } from "react-ripple-click";
import OnBoardDialog from "./OnBoardDialog";
import { getMediaDuration } from "@/utils/ffmpegHelperUtils";
import { useFileStore } from "@/stores/useFileStore";
import DownloadFromInternet from "./DownloadFromInternet";

interface FileUploadProps {
  setFilePath: (filePath: string) => void;
}

function FileUpload({ setFilePath }: FileUploadProps) {
  const { t } = useTranslation();
  const { setDuration } = useFileStore();

  const onFileUpload = useCallback(
    async function onFileUpload() {
      const selectedFile = await open({
        multiple: false,
        filters: [
          {
            name: "Video/Audio",
            extensions: [
              "mp4",
              "avi",
              "mov",
              "mkv",
              "wmv",
              "flv",
              "webm",
              "aac",
              "mp3",
              "ogg",
              "wav",
              "m4a",
            ],
          },
        ],
      });
      if (selectedFile === undefined) return;
      await getMediaDuration(selectedFile as string).then((data) => {
        setDuration(data);

        setFilePath(selectedFile as string);
      });
    },
    [setFilePath, setDuration],
  );

  //Press ctrl+O to open the file uploader
  useEffect(() => {
    function registerShorcut(e: KeyboardEvent) {
      if ((e.ctrlKey || e.metaKey) && e.key === "o") {
        onFileUpload();
      }
    }
    document.addEventListener("keydown", registerShorcut);

    return () => document.removeEventListener("keydown", registerShorcut);
  }, [onFileUpload]);

  return (
    <>
      <OnBoardDialog />
      <div className="flex h-[100vh] flex-col items-center justify-center gap-3 text-center">
        <div className="w-56">
          <svg
            className="fill-foreground"
            viewBox="0 0 46.606689 20.561392"
            version="1.1"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path d="m 41.651562,13.332047 h 1.013188 c 0.949865,0 1.672818,-0.09298 2.168858,-0.278939 0.496041,-0.196291 0.744061,-0.37192 0.744061,-0.526886 0,-0.268608 -0.08971,-0.537217 -0.269129,-0.805825 -0.168864,-0.278939 -0.385222,-0.52172 -0.649074,-0.728341 l 1.060683,-2.6654212 c 0.316622,0.423575 0.543534,0.90397 0.680735,1.441187 0.137204,0.5372172 0.205804,1.0692672 0.205804,1.5961532 0,0.919467 -0.174141,1.771781 -0.522425,2.556944 -0.348283,0.774831 -0.844324,1.399863 -1.488121,1.875092 -0.633242,0.475231 -1.393134,0.712846 -2.279675,0.712846 h -0.664905 c -0.263852,0 -0.459101,-0.180794 -0.58575,-0.542383 -0.126648,-0.361587 -0.189973,-0.728341 -0.189973,-1.100261 0,-0.361587 0.06332,-0.707678 0.189973,-1.038274 0.126649,-0.330595 0.321898,-0.495892 0.58575,-0.495892 z m 2.646484,3.897569 c 0.696567,0.47523 1.266487,1.033108 1.709757,1.673636 l -1.709757,1.65814 c -0.221636,-0.320263 -0.474932,-0.619865 -0.759892,-0.898805 -0.284959,-0.268608 -0.596303,-0.52172 -0.934033,-0.759335 z m -2.646484,-0.720759 c -0.738784,0 -1.308703,-0.02583 -1.709757,-0.07749 -0.401054,-0.06199 -0.712398,-0.170463 -0.934033,-0.32543 -0.211081,-0.165297 -0.406331,-0.408078 -0.58575,-0.728341 l 0.14248,-0.06199 c -0.158311,0.268608 -0.432717,0.537217 -0.823217,0.805825 -0.3905,0.258277 -0.828492,0.387416 -1.313979,0.387416 -0.928756,0 -1.567276,-0.351257 -1.91556,-1.053771 l 0.142479,0.03099 c -0.221635,0.258277 -0.564642,0.495892 -1.029019,0.712846 -0.453825,0.206621 -1.076515,0.309932 -1.868068,0.309932 -0.559365,0 -1.060682,-0.07748 -1.503952,-0.23245 -0.44327,-0.154966 -0.844325,-0.47523 -1.203162,-0.960791 l 0.158311,-0.03099 c -0.379945,0.340926 -0.733506,0.599203 -1.060682,0.774832 -0.327176,0.175628 -0.707122,0.294436 -1.139838,0.356422 -0.432716,0.06199 -0.997358,0.09298 -1.693926,0.09298 -0.26385,0 -0.443269,-0.1498 -0.538256,-0.449402 -0.09499,-0.309933 -0.142479,-0.692183 -0.142479,-1.146751 0,-0.423575 0.05805,-0.790328 0.174142,-1.100261 0.105541,-0.320263 0.274405,-0.480396 0.506593,-0.480396 1.044852,0 1.836406,-0.06715 2.374662,-0.201456 0.548812,-0.134304 0.960419,-0.366753 1.234824,-0.697348 0.274406,-0.340926 0.53298,-0.810991 0.775723,-1.410193 h 0.237467 c -0.116095,0.568209 -0.07916,1.022777 0.110817,1.363703 0.200527,0.330595 0.485486,0.573375 0.854879,0.728341 0.369391,0.144636 0.754613,0.216953 1.155668,0.216953 0.759891,0 1.435351,-0.134303 2.026378,-0.402912 0.591027,-0.27894 1.092344,-0.914302 1.503951,-1.906085 h 0.237467 c -0.168864,0.847149 -0.163589,1.446351 0.01583,1.797608 0.179418,0.340926 0.559364,0.511389 1.139837,0.511389 0.44327,0 0.812662,-0.144635 1.108176,-0.433905 0.295512,-0.28927 0.532979,-0.614699 0.712397,-0.976288 0.17942,-0.371919 0.316623,-0.67152 0.411609,-0.898804 h 0.237466 c -0.147757,0.702513 -0.19525,1.219067 -0.14248,1.549663 0.05278,0.320263 0.258578,0.526885 0.617412,0.619865 0.369392,0.09298 0.944588,0.139469 1.725587,0.139469 0.306068,0 0.532981,0.165298 0.680738,0.495893 0.147755,0.320263 0.221634,0.681852 0.221634,1.084764 0,0.433905 -0.07388,0.810991 -0.221634,1.131254 -0.137204,0.309933 -0.364116,0.464899 -0.680738,0.464899 z m -23.303344,0 c -0.232189,0 -0.416885,-0.154966 -0.554088,-0.464899 -0.147756,-0.320264 -0.221635,-0.697349 -0.221635,-1.131254 0,-0.423575 0.07387,-0.790329 0.221635,-1.100261 0.137203,-0.320264 0.321899,-0.480396 0.554088,-0.480396 h 0.07915 c 0.854879,0 1.514507,-0.07231 1.978886,-0.216953 0.474932,-0.144635 0.839046,-0.408078 1.092344,-0.790328 0.253297,-0.392582 0.490763,-0.95046 0.712398,-1.673636 l 0.253297,0.0465 c -0.04222,0.268608 -0.06332,0.521719 -0.06332,0.759334 0,0.764501 0.232189,1.270724 0.696568,1.51867 0.464378,0.237615 1.1715,0.356423 2.121364,0.356423 h 0.07915 c 0.253298,0 0.459102,0.160132 0.617412,0.480395 0.158311,0.309933 0.237466,0.676687 0.237466,1.100261 0,0.433906 -0.07915,0.810991 -0.237466,1.131255 -0.147757,0.309932 -0.353561,0.464899 -0.617412,0.464899 h -0.316614 c -1.076513,0 -1.883898,-0.191126 -2.422155,-0.573376 -0.538253,-0.392582 -0.960415,-0.960792 -1.266483,-1.70463 l 0.585751,0.123974 c -0.369393,0.609534 -0.823217,1.120922 -1.361474,1.534166 -0.527702,0.413244 -1.145114,0.619866 -1.852236,0.619866 z m 1.662263,0.720759 c 0.696568,0.47523 1.266486,1.033108 1.709757,1.673636 l -1.709757,1.65814 c -0.221636,-0.320263 -0.474933,-0.619865 -0.759891,-0.898805 -0.28496,-0.268608 -0.596304,-0.52172 -0.934034,-0.759335 z m 3.102891,0 c 0.696568,0.47523 1.266486,1.033108 1.709756,1.673636 l -1.709756,1.65814 C 22.891737,20.241129 22.63844,19.941527 22.353481,19.662587 22.06852,19.393979 21.757176,19.140867 21.419448,18.903252 Z M 6.8231941,16.834286 c -1.182054,0 -2.205797,-0.175629 -3.071228,-0.526886 C 2.8865331,15.945813 2.1477491,15.480914 1.5356141,14.912704 0.92348005,14.344493 0.41160805,13.734959 4.3733729e-8,13.084101 L 0.09499005,12.882645 c 0.90764805,0.268608 1.91556105,0.464899 3.02373705,0.588872 1.118729,0.123973 2.205795,0.185959 3.261201,0.185959 z M 14.99203,7.4898168 c 0.907649,0 1.588384,0.23245 2.042208,0.697348 0.453825,0.454568 0.680738,1.033109 0.680738,1.735623 0,0.9711222 -0.327176,1.8750922 -0.981528,2.7119102 -0.643797,0.836819 -1.503952,1.570326 -2.580465,2.200522 -1.076513,0.630196 -2.258567,1.120923 -3.546161,1.47218 -1.2770399,0.351257 -2.5488029,0.526886 -3.8152899,0.526886 l -0.443271,-3.17681 c 1.203163,0 2.364108,-0.03616 3.482838,-0.108476 1.1292829,-0.08265 2.1424719,-0.201456 3.0395659,-0.356423 0.897094,-0.154966 1.609493,-0.356422 2.137196,-0.604368 0.527702,-0.258277 0.791554,-0.563044 0.791554,-0.914301 0,-0.423575 -0.232189,-0.800659 -0.696568,-1.131254 -0.453824,-0.340927 -1.076513,-0.51139 -1.868066,-0.51139 -0.253298,0 -0.643798,0.113642 -1.1715,0.340927 -0.527703,0.216953 -1.113453,0.516554 -1.75725,0.898804 -0.6437959,0.371919 -1.2875939,0.795494 -1.9313909,1.270724 -0.643797,0.475231 -1.208439,0.965957 -1.693926,1.47218 l -0.981527,-0.07748 c 0.601582,-0.640528 1.292872,-1.332711 2.073872,-2.076549 0.791554,-0.743838 1.614768,-1.446352 2.4696469,-2.1075412 0.854879,-0.66119 1.688649,-1.203572 2.501311,-1.627147 0.823216,-0.423574 1.572554,-0.635362 2.248013,-0.635362 z M 7.5039301,12.510725 C 7.5355931,8.9774938 7.4089431,3.4919078 7.1239851,-2.2004662e-7 7.3561731,0.14463578 7.5883631,0.28410478 7.8205521,0.41840978 c 0.242743,0.134303 0.48021,0.263442 0.712399,0.387415 0.15831,2.95469202 0.15831,7.87723302 0,10.82159322 -0.168866,0.165297 -0.343008,0.320263 -0.522426,0.464899 -0.168865,0.144635 -0.337729,0.284105 -0.506595,0.418408 z m 7.2348019,0.945295 c 0.559365,-0.07232 1.155669,-0.108476 1.788912,-0.108476 0.633243,-0.01034 1.234824,-0.0155 1.804743,-0.0155 0.168865,0 0.311344,0.160133 0.427439,0.480396 0.116094,0.320264 0.174142,0.687017 0.174142,1.100261 0,0.454568 -0.06332,0.836818 -0.189974,1.146751 -0.116094,0.299602 -0.253296,0.449402 -0.411607,0.449402 -1.329811,0 -2.474926,-0.08782 -3.435344,-0.263443 -0.960419,-0.175628 -1.952499,-0.506223 -2.976242,-0.991784 z" />
          </svg>
        </div>
        <hr className="mt-2 h-[2px] w-[90vw] border-none bg-border md:w-[600px]" />
        <button
          onClick={onFileUpload}
          className="flex justify-center rounded-md border-2 border-dashed border-border"
        >
          <div className="ripple flex w-[90vw] cursor-pointer flex-col items-center border-border bg-muted py-[10vh] hover:bg-accent md:w-[600px]">
            <Ripple />
            <OpenFileIcon />
            {t("uploadPage.uploadFileLabel")}
          </div>
        </button>
        <div className="flex w-[90vw] items-center gap-2 md:w-[600px]">
          <hr className="mt-2 h-[2px] w-full border-none bg-border" />
          <p>{t("uploadPage.or")}</p>
          <hr className="mt-2 h-[2px] w-full border-none bg-border" />
        </div>
        <DownloadFromInternet />
      </div>
    </>
  );
}

export default FileUpload;

function OpenFileIcon() {
  return (
    <svg
      role="graphics-symbol"
      viewBox="0 0 24 24"
      width="30px"
      height="30px"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <g strokeWidth="0"></g>
      <g strokeLinecap="round" strokeLinejoin="round"></g>
      <g>
        <path
          fillRule="evenodd"
          clipRule="evenodd"
          d="M17.5754 23.2323C17.2093 23.6996 16.6397 24 16 24H2C0.89543 24 0 23.1046 0 22V6H5C5.55228 6 6 5.55228 6 5V0H16C17.1046 0 18 0.89543 18 2V6.75463C16.6304 5.65672 14.8919 5 13 5C8.58172 5 5 8.58172 5 13C5 17.4183 8.58172 21 13 21C13.7166 21 14.4113 20.9058 15.0722 20.729L17.5754 23.2323ZM0.341411 4C0.943981 2.29517 2.29517 0.943981 4 0.341411V4H0.341411ZM17.8603 16.5189C17.9545 16.5659 18.0428 16.6286 18.1213 16.7071L23.1213 21.7071C23.5118 22.0976 23.5118 22.7308 23.1213 23.1213C22.7308 23.5118 22.0976 23.5118 21.7071 23.1213L16.7071 18.1213C16.6286 18.0428 16.5659 17.9545 16.5189 17.8603C15.5304 18.5773 14.3146 19 13 19C9.68629 19 7 16.3137 7 13C7 9.68629 9.68629 7 13 7C16.3137 7 19 9.68629 19 13C19 14.3146 18.5773 15.5304 17.8603 16.5189ZM13 17C15.2091 17 17 15.2091 17 13C17 10.7909 15.2091 9 13 9C10.7909 9 9 10.7909 9 13C9 15.2091 10.7909 17 13 17Z"
          fill="currentColor"
        ></path>
      </g>
    </svg>
  );
}
